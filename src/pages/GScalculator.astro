---
import Layout from '~/layouts/PageLayout.astro';
import HeroText from '~/components/widgets/HeroText.astro';

const metadata = {
  title: 'โปรแกรมคำนวณความชื้นเมล็ด - Grainsure',
};
---

<Layout metadata={metadata}>
  
<section class="relative md:-mt-[76px] not-prose">
    <div class="relative max-w-6xl mx-auto px-4 sm:px-6">
      <div class="pt-12 md:pt-20 pb-8 md:pb-12 text-center">
        
        <p class="text-base text-green-700 dark:text-green-400 font-bold tracking-wide uppercase mb-2">
          Tools
        </p>

        <h1 class="text-2xl md:text-4xl font-bold leading-tight tracking-tighter mb-4 font-heading dark:text-gray-200">
          โปรแกรมคำนวณความชื้น
          <br class="block sm:hidden" />
          <span class="text-green-700 dark:text-green-400">ต้นทุนและกำไร</span>
        </h1>

        <p class="max-w-3xl mx-auto text-sm md:text-xl text-gray-600 dark:text-slate-400">
          คำนวณหาน้ำหนักน้ำ เนื้อแห้ง และเปรียบเทียบราคาอย่างง่ายดาย
        </p>
        
      </div>
    </div>
  </section>
  <section class="px-4 py-8 mx-auto max-w-5xl">
    <div id="grain-calc-wrapper" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl overflow-hidden border border-gray-200 dark:border-slate-700">
      
      <div id="grain-calc-header" class="bg-gradient-to-r from-green-700 to-green-800 p-6 text-center text-white">
        <h2 class="text-xl md:text-2xl font-bold tracking-tight">
          Grain Moisture Calculator
        </h2>
        <p class="text-green-100 text-sm md:text-base mt-1 opacity-90">
          เครื่องมือคำนวณความชื้นแม่นยำ
        </p>
      </div>
      
      <div class="p-6 md:p-8">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-6">
          <div class="gc-form-group">
            <label class="block text-sm md:text-base font-semibold text-gray-700 dark:text-gray-300 mb-2">
              น้ำหนักเมล็ดสด (กก./ตัน) <span class="text-green-600 dark:text-green-400">[เริ่มต้น]</span>
            </label>
            <input type="number" id="inpWeight" placeholder="เช่น 1000" 
              class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition text-base md:text-lg"
            >
          </div>
          <div class="gc-form-group">
            <label class="block text-sm md:text-base font-semibold text-gray-700 dark:text-gray-300 mb-2">
              ความชื้นปัจจุบัน (%) <span class="text-green-600 dark:text-green-400">[เริ่มต้น]</span>
            </label>
            <input type="number" id="inpMoistInit" placeholder="เช่น 25" 
              class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition text-base md:text-lg"
            >
          </div>
          <div class="gc-form-group">
            <label class="block text-sm md:text-base font-semibold text-gray-700 dark:text-gray-300 mb-2">
              ลดเหลือความชื้น (%) <span class="text-blue-600 dark:text-blue-400">[เป้าหมาย]</span>
            </label>
            <input type="number" id="inpMoistTarget" value="15" 
              class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-slate-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition text-base md:text-lg"
            >
          </div>
        </div>

        <label class="flex items-center p-4 bg-gray-50 dark:bg-slate-700/50 rounded-lg cursor-pointer border border-gray-200 dark:border-slate-600 hover:bg-gray-100 dark:hover:bg-slate-700 transition mb-6 select-none">
          <input type="checkbox" id="chkPriceOption" class="w-5 h-5 text-green-600 rounded focus:ring-green-500 border-gray-300">
          <span class="ml-3 text-sm md:text-base font-medium text-gray-700 dark:text-gray-200">
            ต้องการคำนวณราคา/กำไร (Option)
          </span>
        </label>

        <div id="sec-price-inputs" class="hidden bg-green-50 dark:bg-slate-700/30 p-4 md:p-6 rounded-xl border border-dashed border-green-300 dark:border-green-700 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">ราคาขายสด (บาท/หน่วย)</label>
              <input type="number" id="inpPriceFresh" placeholder="ราคาหน้าลาน" class="w-full p-2.5 rounded border border-gray-300 dark:border-gray-600 dark:bg-slate-800 dark:text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">ราคาเมล็ดแห้ง (บาท/หน่วย)</label>
              <input type="number" id="inpPriceDry" placeholder="ราคารับซื้อเมื่อแห้ง" class="w-full p-2.5 rounded border border-gray-300 dark:border-gray-600 dark:bg-slate-800 dark:text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">ค่าจ้างตาก/อบ (บาท/หน่วย)</label>
              <input type="number" id="inpCostDrying" value="0" placeholder="ถ้าตากเองใส่ 0" class="w-full p-2.5 rounded border border-gray-300 dark:border-gray-600 dark:bg-slate-800 dark:text-white focus:border-green-500 focus:ring-1 focus:ring-green-500 outline-none">
            </div>
          </div>
          <div class="text-xs text-gray-500 dark:text-gray-400 mt-2">*กรอกข้อมูลให้ครบเพื่อเปรียบเทียบความคุ้มค่า</div>
        </div>

        <button id="btnCalc" class="w-full py-3 md:py-4 px-6 bg-green-700 hover:bg-green-800 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transform active:scale-[0.98] transition duration-200 text-base md:text-xl">
          คำนวณผลลัพธ์
        </button>

        <div id="gc-result-area" class="hidden mt-8 md:mt-10 animate-fade-in-up">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
            <div class="gc-card fresh bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-xl shadow-sm p-5 md:p-6 border-t-[6px] border-t-orange-500">
              <div class="text-center font-bold text-lg md:text-xl mb-4 text-gray-800 dark:text-white">
                1. สภาวะเริ่มต้น (สด)
              </div>
              
              <div class="space-y-3 text-sm md:text-base">
                <div class="flex justify-between items-center pb-2 border-b border-gray-100 dark:border-slate-700">
                  <span class="text-gray-500 dark:text-gray-400">ความชื้น</span>
                  <span class="font-bold text-gray-900 dark:text-white"><span id="lblM1" class="text-lg">0</span>%</span>
                </div>
                <div class="flex justify-between items-center pb-2 border-b border-gray-100 dark:border-slate-700">
                  <span class="text-gray-500 dark:text-gray-400">น้ำหนักน้ำ</span>
                  <span class="font-bold text-blue-600 dark:text-blue-400" id="lblWater1">0</span>
                </div>
                <div class="flex justify-between items-center pb-2 border-b border-gray-100 dark:border-slate-700">
                  <span class="text-gray-500 dark:text-gray-400">เนื้อเมล็ดแห้ง</span>
                  <span class="font-bold text-orange-600 dark:text-orange-400" id="lblDry1">0</span>
                </div>
                <div class="flex justify-between items-center pt-2 font-bold text-lg md:text-xl text-gray-900 dark:text-white">
                  <span>น้ำหนักรวม</span>
                  <span id="lblW1">0</span>
                </div>
              </div>
              
              <div class="row-financial mt-4 pt-4 border-t border-dashed border-orange-300 dark:border-orange-700">
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300 mb-2">
                  <span>ราคาขาย/หน่วย</span>
                  <span><span id="lblP1" class="font-semibold">0</span> บ.</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="font-semibold text-gray-700 dark:text-gray-200">รายได้สุทธิ</span>
                  <div class="text-xl md:text-2xl font-extrabold text-green-700 dark:text-green-400">
                    <span id="resMoney1">0</span> บาท
                  </div>
                </div>
              </div>
            </div>

            <div class="gc-card dry bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-xl shadow-sm p-5 md:p-6 border-t-[6px] border-t-green-500">
              <div class="text-center font-bold text-lg md:text-xl mb-4 text-gray-800 dark:text-white">
                2. เป้าหมาย (แห้ง)
              </div>
              
              <div class="space-y-3 text-sm md:text-base">
                <div class="flex justify-between items-center pb-2 border-b border-gray-100 dark:border-slate-700">
                  <span class="text-gray-500 dark:text-gray-400">ความชื้น</span>
                  <span class="font-bold text-gray-900 dark:text-white"><span id="lblM2" class="text-lg">0</span>%</span>
                </div>
                <div class="flex justify-between items-center pb-2 border-b border-gray-100 dark:border-slate-700">
                  <span class="text-gray-500 dark:text-gray-400">น้ำหนักน้ำ</span>
                  <span class="font-bold text-blue-600 dark:text-blue-400" id="lblWater2">0</span>
                </div>
                <div class="flex justify-between items-center pb-2 border-b border-gray-100 dark:border-slate-700">
                  <span class="text-gray-500 dark:text-gray-400">เนื้อเมล็ดแห้ง</span>
                  <span class="font-bold text-orange-600 dark:text-orange-400" id="lblDry2">0</span>
                </div>
                <div class="flex justify-between items-center pt-2 font-bold text-lg md:text-xl text-gray-900 dark:text-white">
                  <span>น้ำหนักรวม</span>
                  <span id="lblW2">0</span>
                </div>
              </div>

              <div class="row-financial mt-4 pt-4 border-t border-dashed border-green-300 dark:border-green-700">
                <div class="flex justify-between text-sm text-gray-600 dark:text-gray-300 mb-1">
                  <span>ราคาขายเมล็ดแห้ง</span>
                  <span><span id="lblP2" class="font-semibold">0</span> บ.</span>
                </div>
                <div class="flex justify-between text-sm text-red-500 mb-2">
                  <span>หัก: ค่าอบ</span>
                  <span>-<span id="lblCost">0</span> บ.</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="font-semibold text-gray-700 dark:text-gray-200">รายได้สุทธิ</span>
                  <div class="text-xl md:text-2xl font-extrabold text-green-700 dark:text-green-400">
                    <span id="resMoney2">0</span> บาท
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-6 p-4 md:p-5 bg-orange-50 dark:bg-orange-900/20 border border-dashed border-orange-300 dark:border-orange-700 rounded-lg text-center">
             <span class="text-orange-800 dark:text-orange-200 text-sm md:text-base">สรุป: น้ำหนักหายไปจากการตาก</span> 
             <div class="text-2xl md:text-3xl font-bold text-orange-600 dark:text-orange-400 mt-1">
               <span id="lblLossTotal">0</span> <span class="text-lg font-normal text-orange-800 dark:text-orange-200">(หน่วย**)</span>
             </div>
          </div>

          <div id="sec-winner" class="hidden mt-6 p-6 bg-white dark:bg-slate-800 border-2 border-green-600 rounded-xl text-center shadow-md">
            <div class="text-lg text-gray-600 dark:text-gray-300 mb-2 font-medium">บทสรุปความคุ้มค่า</div>
            <div id="txtWinner" class="text-xl md:text-2xl font-bold">...</div>
          </div>

        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  // Function Format ตัวเลข
  function formatNum(num) {
    return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  // Toggle ส่วนราคา
  function togglePriceSection() {
    const chk = document.getElementById('chkPriceOption') as HTMLInputElement;
    if (!chk) return;
    const isChecked = chk.checked;
    const priceSection = document.getElementById('sec-price-inputs');
    const resultArea = document.getElementById('gc-result-area');
    
    // ใช้ classList.remove/add แทน style.display เพื่อให้ CSS ทำงานได้ดีกว่า
    if (priceSection) {
        if(isChecked) priceSection.classList.remove('hidden');
        else priceSection.classList.add('hidden');
    }

    if (!isChecked && resultArea) resultArea.classList.add('hidden');
  }

  // คำนวณหลัก
  function calcGrainSmart() {
    const W_init = parseFloat((document.getElementById('inpWeight') as HTMLInputElement).value);
    const M_init = parseFloat((document.getElementById('inpMoistInit') as HTMLInputElement).value);
    const M_target = parseFloat((document.getElementById('inpMoistTarget') as HTMLInputElement).value);
    const wantPrice = (document.getElementById('chkPriceOption') as HTMLInputElement).checked;

    if (isNaN(W_init) || isNaN(M_init) || isNaN(M_target)) {
      alert("กรุณากรอกข้อมูลน้ำหนักและความชื้นให้ครบ");
      return;
    }
    if (M_target >= M_init) {
      alert("ความชื้นเป้าหมาย ต้องน้อยกว่า ความชื้นเริ่มต้น");
      return;
    }

    // ฟิสิกส์
    const dryMatter = W_init * (100 - M_init) / 100;
    const waterInit = W_init - dryMatter;
    const W_final = dryMatter / ((100 - M_target) / 100);
    const waterFinal = W_final - dryMatter;
    const weightLoss = W_init - W_final;

    // แสดงผล
    document.getElementById('lblM1').innerText = M_init.toString();
    document.getElementById('lblW1').innerText = formatNum(W_init);
    document.getElementById('lblWater1').innerText = formatNum(waterInit);
    document.getElementById('lblDry1').innerText = formatNum(dryMatter);

    document.getElementById('lblM2').innerText = M_target.toString();
    document.getElementById('lblW2').innerText = formatNum(W_final);
    document.getElementById('lblWater2').innerText = formatNum(waterFinal);
    document.getElementById('lblDry2').innerText = formatNum(dryMatter);
    document.getElementById('lblLossTotal').innerText = formatNum(weightLoss);

    // การเงิน
    const financialRows = document.querySelectorAll('.row-financial');
    const winnerBox = document.getElementById('sec-winner');

    if (wantPrice) {
      const P_fresh = parseFloat((document.getElementById('inpPriceFresh') as HTMLInputElement).value);
      const P_dry = parseFloat((document.getElementById('inpPriceDry') as HTMLInputElement).value);
      const Cost_per_ton = parseFloat((document.getElementById('inpCostDrying') as HTMLInputElement).value);

      if (isNaN(P_fresh) || isNaN(P_dry)) {
        alert("กรุณากรอกราคาขายให้ครบถ้วน");
        return;
      }

      const Income_Fresh = W_init * P_fresh;
      const Income_Dry_Gross = W_final * P_dry;
      const Total_Drying_Cost = (W_init / 1000) * (isNaN(Cost_per_ton) ? 0 : Cost_per_ton);
      const Income_Dry_Net = Income_Dry_Gross - Total_Drying_Cost;

      document.getElementById('lblP1').innerText = formatNum(P_fresh);
      document.getElementById('resMoney1').innerText = formatNum(Income_Fresh);
      
      document.getElementById('lblP2').innerText = formatNum(P_dry);
      document.getElementById('lblCost').innerText = formatNum(Total_Drying_Cost);
      document.getElementById('resMoney2').innerText = formatNum(Income_Dry_Net);

      const diff = Income_Dry_Net - Income_Fresh;
      const txtWinner = document.getElementById('txtWinner');
      
      if (diff > 0) {
        txtWinner.innerHTML = `<span class="text-green-700 dark:text-green-400">"ตากแล้วขาย"</span> ได้เพิ่ม ${formatNum(diff)} บาท`;
        winnerBox.style.borderColor = "#15803d";
      } else if (diff < 0) {
        txtWinner.innerHTML = `<span class="text-red-600 dark:text-red-400">"ขายสดทันที"</span> คุ้มกว่า ${formatNum(Math.abs(diff))} บาท`;
        winnerBox.style.borderColor = "#dc2626";
      } else {
        txtWinner.innerHTML = "ทั้งสองทางเลือก ได้เงินเท่ากัน";
        winnerBox.style.borderColor = "#ca8a04";
      }

      financialRows.forEach(el => (el as HTMLElement).style.display = 'block');
      if (winnerBox) winnerBox.classList.remove('hidden');

    } else {
      financialRows.forEach(el => (el as HTMLElement).style.display = 'none');
      if (winnerBox) winnerBox.classList.add('hidden');
    }

    const resultArea = document.getElementById('gc-result-area');
    if (resultArea) resultArea.classList.remove('hidden');
  }

  // Event Listeners
  document.addEventListener('astro:page-load', () => {
     const btn = document.getElementById('btnCalc');
     if(btn) btn.addEventListener('click', calcGrainSmart);

     const chk = document.getElementById('chkPriceOption');
     if(chk) chk.addEventListener('change', togglePriceSection);
  });
  
  document.addEventListener('DOMContentLoaded', () => {
     const btn = document.getElementById('btnCalc');
     if(btn) btn.addEventListener('click', calcGrainSmart);

     const chk = document.getElementById('chkPriceOption');
     if(chk) chk.addEventListener('change', togglePriceSection);
  });
</script>

<style>
  /* เหลือไว้เฉพาะ CSS ที่จำเป็นจริงๆ หรือ Tailwind ทำไม่ได้ง่ายๆ */
  .animate-fade-in-up {
    animation: fadeInUp 0.5s ease-out;
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>